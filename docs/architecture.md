# Архитектура

Проект разбит на отдельные микросервисы и инфраструктурные компоненты:

- **Telegram-бот (aiogram)** — принимает платежи Telegram Stars, выдает триал и конфиги, отправляет напоминания.
- **Billing (FastAPI + APScheduler)** — тарификация, работа с промокодами/рефералкой, выставление инвойсов и умные напоминания про окончание подписки/grace-period.
- **Provisioner (FastAPI)** — генерация конфигураций AmneziaWG/WireGuard/OpenVPN и QR-кодов, ограничение скорости/устройств и rate-limit по трафику.
- **Dashboard (FastAPI + Jinja2)** — простая веб-панель для статусов и скачивания конфигов.
- **База данных (PostgreSQL)** — хранение подписок, платежей, рефералок, устройств.
- **Redis** — кеш и сессионные данные бота.
- **MinIO/R2** — безопасное хранение конфигов, QR и бэкапов.
- **AmneziaWG/Cloak контейнер** — отдельный сервис внутри Compose, отдающий зашифрованные профили с маскировкой OpenVPN-over-TLS.
- **QoS tooling** — `scripts/cake-autorate.sh` для равномерного шейпинга 1 Gbps каналов с tc + CAKE.

В `docker-compose.yml` описаны сервисы для локального и стартового прод-окружения. Подключение к Neon/Yandex Managed можно сделать заменой хоста/порта в переменных окружения без изменения кода.
